<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Smallo Booth</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #FFF5E1;
}

/* ===== FULLSCREEN HIDDEN BUTTON ===== */
#fsBtn {
  position: fixed;
  bottom: 6px;
  right: 6px;
  width: 30px;
  height: 30px;
  opacity: 0.02; /* extremely hidden */
  z-index: 999;
}

/* ===== DISPLAY LAYOUT ===== */
.displayRoot {
  display: flex;
  width: 100vw;
  height: 100vh;
}

/* LEFT: MENU */
.menuPane {
  width: 50%;
  height: 100%;
  background: white;
}

/* RIGHT: CONTENT */
.rightPane {
  width: 50%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* SMALLO */
.smalloPane {
  height: 50%;
  position: relative;
}

/* PRODUCT PREVIEW */
.previewPane {
  height: 50%;
  background: #f3f3f3;
  display: flex;
  justify-content: center;
  align-items: center;
}

.previewPane img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
}

/* ===== SMALLO STAGE ===== */
.stage {
  position: relative;
  width: 100%;
  height: 100%;
}

video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
}
</style>
</head>

<body>

<!-- hidden fullscreen trigger -->
<div id="fsBtn" onclick="goFullscreen()"></div>

<div id="app"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyC7FVnMrkhPIF3fJE0JZEmwjDALSFc7SFc",
  databaseURL: "https://smallo-live-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db = firebase.database();
const actionRef = db.ref("action");
const app = document.getElementById("app");

const PATHS = {
  idle: "idle/",
  random: "random-actions/",
  special: "special-actions/",
  products: "product-previews/"
};

/* ===== FULLSCREEN ===== */
function goFullscreen() {
  const el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}

/* ===== PRODUCT PREVIEW ===== */
const productImages = [
  "product1.jpg",
  "product2.jpg",
  "product3.jpg"
];

let productIndex = 0;
function startProductCarousel(imgEl) {
  imgEl.src = PATHS.products + productImages[0];
  setInterval(() => {
    productIndex = (productIndex + 1) % productImages.length;
    imgEl.src = PATHS.products + productImages[productIndex];
  }, 4000);
}

/* ===== RENDER ===== */
function render() {
  const mode = location.hash.replace("#", "");
  app.innerHTML = "";

  if (mode === "display") {
    app.innerHTML = `
      <div class="displayRoot">
        <!-- MENU -->
        <div class="menuPane">
          <!-- Replace src with your Canva embed -->
          <iframe
            src="https://www.canva.com/"
            style="border:none;width:100%;height:100%;"
            allowfullscreen>
          </iframe>
        </div>

        <!-- RIGHT SIDE -->
        <div class="rightPane">
          <div class="smalloPane">
            <div class="stage">
              <video id="idle" muted playsinline></video>
              <video id="action" muted playsinline></video>
            </div>
          </div>

          <div class="previewPane">
            <img id="previewImg" alt="Product Preview">
          </div>
        </div>
      </div>
    `;

    /* ===== PRODUCT CAROUSEL START ===== */
    startProductCarousel(document.getElementById("previewImg"));

    /* ===== SMALLO ANIMATION SYSTEM ===== */
    const idle = document.getElementById("idle");
    const action = document.getElementById("action");

    idle.src = PATHS.idle + "idle.mp4";
    idle.loop = false;
    idle.play();

    let queued = null;
    let busy = false;

    function getPath(name, type) {
      if (name === "blink") return PATHS.idle;
      if (type === "special") return PATHS.special;
      return PATHS.random;
    }

    function playQueued() {
      if (!queued || busy) return;
      busy = true;

      const { name, type } = queued;
      queued = null;

      const src = getPath(name, type) + name + ".mp4";

      fetch(src, { method: "HEAD" }).then(res => {
        if (!res.ok) {
          busy = false;
          return;
        }

        action.src = src;
        action.load();
        action.pause();
        action.currentTime = 0;

        action.onloadeddata = () => {
          idle.pause();
          idle.currentTime = 0;
          action.style.zIndex = 2;
          idle.style.zIndex = 1;
          action.play();
        };

        action.onended = () => {
          action.style.zIndex = 0;
          action.src = "";
          idle.play();
          busy = false;
        };
      });
    }

    idle.onended = () => {
      playQueued();
      if (!busy) {
        idle.currentTime = 0;
        idle.play();
      }
    };

    actionRef.on("value", snap => {
      const val = snap.val();
      if (!val) return;
      queued = {
        name: val.name,
        type: ["hello","thank"].includes(val.name) ? "special" : "random"
      };
    });
  }
}

window.addEventListener("hashchange", render);
render();
</script>
</body>
</html>
