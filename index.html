<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Smallo Booth</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body {
    margin: 0;
    background: #FFF5E1;
    font-family: Arial, sans-serif;
  }

  .menu {
    background: rgba(255,165,82,0.55);
    color: white;
    padding: 6px;
    font-size: 13px;
    text-align: center;
  }

  .stage {
    position: relative;
    width: 80%;
    height: 60vh;
    margin: 18px auto;
    background: #FFF5E1;
    overflow: hidden;
  }

  video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #FFF5E1;
    display: block;
  }
</style>
</head>

<body>
<div id="app"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyC7FVnMrkhPIF3fJE0JZEmwjDALSFc7SFc",
  databaseURL: "https://smallo-live-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const actionRef = firebase.database().ref("action");

/* ================= ROUTER ================= */
const mode = location.hash.replace("#", "");
const app = document.getElementById("app");
window.addEventListener("hashchange", () => location.reload());

/* ================= LANDING ================= */
if (!mode) {
  app.innerHTML = `
    <div style="height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px">
      <h2>Smallo Booth</h2>
      <button onclick="location.href='#display'">Display</button>
      <button onclick="location.href='#control'">Control</button>
    </div>`;
}

/* ================= DISPLAY ================= */
if (mode === "display") {
  app.innerHTML = `
    <div class="menu" id="menu">üç´ Smallo is idle</div>
    <div class="stage">
      <video id="mainVideo" muted playsinline></video>
    </div>
  `;

  const menu = document.getElementById("menu");
  const video = document.getElementById("mainVideo");

  let queue = [];
  let playing = "idle";

  const RANDOM_ACTIONS = ["smile","happy","confused","surprised","look","sigh"];

  function play(src, label) {
    video.src = src;
    video.load();
    video.play().catch(()=>{});
    menu.textContent = "üç´ " + label;
  }

  function enqueue(action) {
    queue.push(action);
  }

  function idleLoop() {
    play("idle/idle.mp4", "Idle");
    playing = "idle";
  }

  /* Core loop logic ‚Äî EVERYTHING happens here */
  video.onended = () => {
    /* Priority 1: queued control action */
    if (queue.length > 0) {
      const action = queue.shift();
      play(action.src, "Playing: " + action.name);
      playing = "action";
      return;
    }

    /* Priority 2: blink / random (decided ONLY at idle boundary) */
    if (playing === "idle") {
      const r = Math.random();

      if (r < 0.45) {
        play("idle/blink.mp4", "Blink");
        playing = "blink";
        return;
      }

      if (r < 0.65) {
        const name = RANDOM_ACTIONS[Math.floor(Math.random()*RANDOM_ACTIONS.length)];
        play("random-actions/" + name + ".mp4", "Playing: " + name);
        playing = "random";
        return;
      }
    }

    /* Fallback: continue idle loop */
    idleLoop();
  };

  /* Start */
  idleLoop();

  /* Firebase listener */
  actionRef.on("value", snap => {
    const val = snap.val();
    if (!val || !val.name) return;

    let folder = "random-actions";
    if (["hello","thank"].includes(val.name)) folder = "special-actions";

    const src = folder + "/" + val.name + ".mp4";

    fetch(src, { method: "HEAD" }).then(res => {
      if (!res.ok) {
        menu.textContent = "üç´ Missing animation, playing idle";
        return;
      }

      enqueue({ name: val.name, src });
      menu.textContent = "üç´ Queued: " + val.name;
    });
  });
}

/* ================= CONTROL ================= */
if (mode === "control") {
  app.innerHTML = `
    <div style="padding:16px;max-width:520px;margin:auto">
      <h3>Special Actions</h3>
      <button onclick="send('hello')">Hello</button>
      <button onclick="send('thank')">Thank</button>

      <h3 style="margin-top:16px">Random Actions</h3>
      <button onclick="send('smile')">Smile</button>
      <button onclick="send('happy')">Happy</button>
      <button onclick="send('confused')">Confused</button>
      <button onclick="send('surprised')">Surprised</button>
      <button onclick="send('look')">Look</button>
      <button onclick="send('sigh')">Sigh</button>

      <div id="status" style="margin-top:12px;color:#666"></div>
    </div>
  `;

  window.send = name => {
    document.getElementById("status").textContent = "Queued: " + name;
    actionRef.set({
      name,
      ts: Date.now()
    });
  };
}
</script>
</body>
</html>
