<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Smallo Booth</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body {
    margin: 0;
    background: #FFF5E1;
    font-family: Arial, sans-serif;
  }

  .menu {
    background: rgba(255,165,82,0.75);
    color: white;
    padding: 6px;
    font-size: 13px;
    text-align: center;
  }

  .stage {
    position: relative;
    width: 80%;
    height: 60vh;
    margin: 20px auto;
    background: #FFF5E1;
    overflow: hidden;
  }

  video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #FFF5E1;
  }

  #idleVideo { z-index: 1; }
  #actionVideo { z-index: 2; display: none; }
</style>
</head>

<body>
<div id="app"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyC7FVnMrkhPIF3fJE0JZEmwjDALSFc7SFc",
  databaseURL: "https://smallo-live-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const actionRef = firebase.database().ref("action");
const mode = location.hash.replace("#", "");
const app = document.getElementById("app");

window.addEventListener("hashchange", () => location.reload());

/* ---------- LANDING ---------- */
if (!mode) {
  app.innerHTML = `
    <div style="height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px">
      <h2>Smallo Booth</h2>
      <button onclick="location.href='#display'">Display</button>
      <button onclick="location.href='#control'">Control</button>
    </div>`;
}

/* ---------- DISPLAY ---------- */
if (mode === "display") {
  app.innerHTML = `
    <div class="menu" id="menu">üç´ Smallo is idle</div>
    <div class="stage">
      <video id="idleVideo" muted autoplay loop playsinline></video>
      <video id="actionVideo" muted playsinline></video>
    </div>`;

  const menu = document.getElementById("menu");
  const idleVideo = document.getElementById("idleVideo");
  const actionVideo = document.getElementById("actionVideo");

  idleVideo.src = "idle/idle.mp4";
  idleVideo.play().catch(()=>{});

  let busy = false;

  function playAction(name, folder) {
    if (busy) return;
    busy = true;

    const src = `${folder}/${name}.mp4`;
    menu.textContent = "üç´ Playing: " + name;

    fetch(src, { method: "HEAD" }).then(res => {
      if (!res.ok) {
        busy = false;
        menu.textContent = "üç´ Idle";
        return;
      }

      actionVideo.src = src;
      actionVideo.style.display = "block";
      actionVideo.currentTime = 0;
      actionVideo.play().catch(()=>{});

      actionVideo.onended = () => {
        actionVideo.style.display = "none";
        actionVideo.removeAttribute("src");
        busy = false;
        menu.textContent = "üç´ Idle";
      };
    });
  }

  /* Random idle behavior */
  setInterval(() => {
    if (busy) return;
    const r = Math.random();

    if (r < 0.12) {
      playAction("blink", "idle");
    } else if (r < 0.22) {
      const list = ["smile","happy","confused","surprised","look","sigh"];
      playAction(list[Math.floor(Math.random()*list.length)], "random-actions");
    }
  }, 3500);

  /* Firebase actions */
  actionRef.on("value", snap => {
    const v = snap.val();
    if (!v || !v.name) return;

    if (["hello","thank"].includes(v.name)) {
      playAction(v.name, "special-actions");
    } else {
      playAction(v.name, "random-actions");
    }
  });
}

/* ---------- CONTROL ---------- */
if (mode === "control") {
  app.innerHTML = `
    <div style="padding:16px;max-width:520px;margin:auto">
      <h3>Special</h3>
      <button onclick="send('hello')">Hello</button>
      <button onclick="send('thank')">Thank</button>

      <h3 style="margin-top:16px">Random</h3>
      <button onclick="send('smile')">Smile</button>
      <button onclick="send('happy')">Happy</button>
      <button onclick="send('confused')">Confused</button>
      <button onclick="send('surprised')">Surprised</button>
      <button onclick="send('look')">Look</button>
      <button onclick="send('sigh')">Sigh</button>

      <div id="status" style="margin-top:12px;color:#666"></div>
    </div>`;

  window.send = name => {
    document.getElementById("status").textContent = "Queued: " + name;
    actionRef.set({
      name,
      ts: Date.now()
    });
  };
}
</script>
</body>
</html>
 
