<!DOCTYPE html>
<html>
<head>
  <title>Smallo Display</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* LEFT: MENU */
    #menu {
      width: 50%;
      background: #6b8e6e;
      padding: 10px;
      box-sizing: border-box;
      overflow: auto;
    }

    /* RIGHT SIDE */
    #right {
      width: 50%;
      display: flex;
      flex-direction: column;
    }

    /* Smallo corner */
    #smallo {
      height: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #FFF5E1;
      position: relative;
    }

    #smallo video {
      max-height: 100%;
      max-width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* Underlay video for flicker-free transitions */
    #smallo video#underlay {
      z-index: 0;
    }
    #smallo video#main {
      z-index: 1;
    }

    /* Product preview */
    #products {
      height: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #222;
    }

    #products img {
      max-height: 100%;
      max-width: 100%;
    }

    /* Hidden fullscreen button */
    #fs {
      position: fixed;
      bottom: 5px;
      right: 5px;
      opacity: 0.1;
      width: 40px;
      height: 40px;
      z-index: 10;
    }
  </style>
</head>
<body>

  <!-- Left: Canva menu -->
  <div id="menu">
    <div style="position: relative; width: 100%; height: 0; padding-top: 125.0000%;
     padding-bottom: 0; box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16); margin-top: 1.6em; margin-bottom: 0.9em; overflow: hidden;
     border-radius: 8px; will-change: transform;">
      <iframe loading="lazy" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; border: none; padding: 0;margin: 0;"
        src="https://www.canva.com/design/DAHA6CJLYFc/pb-pX-AMcbC9I1zxRAJEAg/view?embed" allowfullscreen="allowfullscreen" allow="fullscreen">
      </iframe>
    </div>
    <a href="https://www.canva.com/design/DAHA6CJLYFc/pb-pX-AMcbC9I1zxRAJEAg/view?utm_content=DAHA6CJLYFc&utm_campaign=designshare&utm_medium=embeds&utm_source=link" target="_blank" rel="noopener">
    </a>
  </div>

  <!-- Right: Smallo + product preview -->
  <div id="right">
    <div id="smallo">
      <!-- Preloaded underlay video -->
      <video id="underlay" autoplay muted loop src="videos/idle.mp4"></video>
      <!-- Main video on top -->
      <video id="main" autoplay muted></video>
    </div>
    <div id="products">
      <img id="productImg" src="products/product1.jpg">
    </div>
  </div>

  <button id="fs"></button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC7FVnMrkhPIF3fJE0JZEmwjDALSFc7SFc",
      authDomain: "smallo-live.firebaseapp.com",
      databaseURL: "https://smallo-live-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smallo-live",
      storageBucket: "smallo-live.firebasestorage.app",
      messagingSenderId: "1017470725882",
      appId: "1:1017470725882:web:929ee126247fcbb51e6343",
      measurementId: "G-QTZTK6G2XL"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const underlay = document.getElementById("underlay");
    const main = document.getElementById("main");

    let isPlayingAction = false;
    let currentAction = "idle";

    function playIdle() {
      currentAction = "idle";
      isPlayingAction = false;
      underlay.src = "videos/idle.mp4";
      underlay.loop = true;
      underlay.play();

      main.src = "";
    }

    function playAction(action) {
      if (isPlayingAction) return;

      isPlayingAction = true;
      currentAction = action;

      main.src = `videos/${action}.mp4`;
      main.loop = false;
      main.currentTime = 0;
      main.style.zIndex = 2;

      main.play().catch(() => {
        // fallback if video missing
        playIdle();
      });
    }

    // When action ends, return to idle
    main.addEventListener("ended", () => {
      playIdle();
    });

    // Firebase listener
    db.ref("action").on("value", snap => {
      const action = snap.val();
      if (!action || action === "idle") return;
      playAction(action);
    });

    // Random blink during idle (45% chance)
    function randomBlink() {
      if (currentAction !== "idle" || isPlayingAction) return;
      if (Math.random() < 0.45) {
        playAction("blink");
      }
    }
    setInterval(randomBlink, Math.random() * 4000 + 8000);

    playIdle();

    // Hidden fullscreen
    document.getElementById("fs").onclick = () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      }
    };

    // Product carousel
    const images = ["products/product1.jpg","products/product2.jpg","products/product3.jpg"];
    let i = 0;
    setInterval(() => {
      i = (i + 1) % images.length;
      document.getElementById("productImg").src = images[i];
    }, 3000);
  </script>

</body>
</html>
