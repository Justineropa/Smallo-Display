<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smallo Display</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html,body{margin:0;height:100%;overflow:hidden;font-family:sans-serif}
#container{display:flex;height:100vh}

#menu{width:50%;background:#6b8e6e;padding:12px;box-sizing:border-box}
#right{width:50%;display:flex;flex-direction:column}

#smallo{height:50%;background:#fff5e1;position:relative;overflow:hidden}
#smallo video{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
#idleVideo{z-index:1}
#actionVideo{z-index:2;opacity:0;transition:opacity .15s linear}

#productPreview{height:50%;background:#000;position:relative;overflow:hidden}
.productImg{
  position:absolute;inset:0;margin:auto;
  max-width:100%;max-height:100%;
  object-fit:contain;
  transition:opacity .6s ease;
}
</style>
</head>
<body>

<div id="container">

<div id="menu">
  <iframe style="width:100%;height:100%;border:none"
  src="https://www.canva.com/design/DAHA6CJLYFc/pb-pX-AMcbC9I1zxRAJEAg/view?embed"
  allowfullscreen></iframe>
</div>

<div id="right">

<div id="smallo">
  <video id="idleVideo" autoplay muted loop playsinline>
    <source src="videos/idle.mp4" type="video/mp4">
  </video>
  <video id="actionVideo" muted playsinline></video>
</div>

<div id="productPreview">
  <img id="imgA" class="productImg" src="product-previews/1.png" style="opacity:1">
  <img id="imgB" class="productImg" src="product-previews/2.png" style="opacity:0">
</div>

</div>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyC7FVnMrkhPIF3fJE0JZEmwjDALSFc7SFc",
  authDomain: "smallo-live.firebaseapp.com",
  databaseURL: "https://smallo-live-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "smallo-live",
  storageBucket: "smallo-live.firebasestorage.app",
  messagingSenderId: "1017470725882",
  appId: "1:1017470725882:web:929ee126247fcbb51e6343",
  measurementId: "G-QTZTK6G2XL"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= PRODUCT CROSSFADE ================= */
const productImgs = [
  "product-previews/1.png",
  "product-previews/2.png",
  "product-previews/3.png",
  "product-previews/4.png",
  "product-previews/5.png"
];

let pIdx = 0;
let showingA = true;
const imgA = document.getElementById("imgA");
const imgB = document.getElementById("imgB");

setInterval(()=>{
  pIdx = (pIdx + 1) % productImgs.length;
  const incoming = showingA ? imgB : imgA;
  const outgoing = showingA ? imgA : imgB;
  incoming.src = productImgs[pIdx];
  incoming.style.opacity = 1;
  outgoing.style.opacity = 0;
  showingA = !showingA;
},4000);

/* ================= STABLE ACTION QUEUE ================= */
const idleVideo = document.getElementById("idleVideo");
const actionVideo = document.getElementById("actionVideo");

let queue = [];
let playing = false;

// Listen for new actions
db.ref("actionQueue").on("child_added", snap=>{
  queue.push({ key:snap.key, name:snap.val() });
  processQueue();
});

function processQueue(){
  if(playing) return;
  if(queue.length === 0) return;

  playing = true;

  const next = queue.shift();
  playAction(next);
}

function playAction(item){
  actionVideo.src = `videos/${item.name}.mp4`;
  actionVideo.load();

  actionVideo.style.opacity = 1;

  actionVideo.play().catch(()=>{
    finishAction(item);
  });

  actionVideo.onended = ()=> finishAction(item);
  actionVideo.onerror = ()=> finishAction(item);
}

function finishAction(item){
  actionVideo.pause();
  actionVideo.currentTime = 0;
  actionVideo.style.opacity = 0;

  // remove from firebase
  db.ref("actionQueue/"+item.key).remove();

  playing = false;
  processQueue();
}
</script>

</body>
</html>
 
