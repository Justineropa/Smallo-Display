<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smallo Display</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

#container {
  display: flex;
  height: 100vh;
}

#menu {
  width: 50%;
  background: #6b8e6e;
  padding: 10px;
  box-sizing: border-box;
}

#right {
  width: 50%;
  display: flex;
  flex-direction: column;
}

#smallo {
  height: 50%;
  position: relative;
  background: #fff5e1;
  overflow: hidden;
}

#smallo video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
}

#actionVideo {
  opacity: 0;
  transition: opacity 0.15s linear;
}

#productPreview {
  height: 50%;
  position: relative;
  background: #000;
  overflow: hidden;
}

.productImg {
  position: absolute;
  inset: 0;
  margin: auto;
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  transition: opacity 0.6s ease;
}

#fsBtn {
  position: fixed;
  top: 10px;
  right: 10px;
  padding: 8px 12px;
  background: rgba(0,0,0,0.6);
  color: white;
  border-radius: 10px;
  cursor: pointer;
  z-index: 9999;
}
</style>
</head>
<body>

<div id="container">

  <div id="menu">
    <iframe 
      src="https://www.canva.com/design/DAHA6CJLYFc/pb-pX-AMcbC9I1zxRAJEAg/view?embed"
      style="width:100%;height:100%;border:none;"
      allowfullscreen>
    </iframe>
  </div>

  <div id="right">
    <div id="smallo">
      <video id="idleVideo" autoplay muted loop playsinline>
        <source src="videos/idle.mp4" type="video/mp4">
      </video>
      <video id="actionVideo" muted playsinline></video>
    </div>

    <div id="productPreview">
      <img id="imgA" class="productImg" src="product-previews/1.png" style="opacity:1">
      <img id="imgB" class="productImg" src="product-previews/2.png" style="opacity:0">
    </div>
  </div>

</div>

<div id="fsBtn">â›¶ Fullscreen</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC7FVnMrkhPIF3fJE0JZEmwjDALSFc7SFc",
  authDomain: "smallo-live.firebaseapp.com",
  databaseURL: "https://smallo-live-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "smallo-live",
  storageBucket: "smallo-live.firebasestorage.app",
  messagingSenderId: "1017470725882",
  appId: "1:1017470725882:web:929ee126247fcbb51e6343"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== ACTION QUEUE SYSTEM ===== */

const queue = [];
let isPlaying = false;

const idleVideo = document.getElementById("idleVideo");
const actionVideo = document.getElementById("actionVideo");

db.ref("actionQueue").on("child_added", snapshot => {
  const data = snapshot.val();
  queue.push({ key: snapshot.key, name: data.name });
  processQueue();
});

function processQueue() {
  if (isPlaying || queue.length === 0) return;

  isPlaying = true;
  const next = queue.shift();
  playAction(next);
}

function playAction(actionObj) {
  actionVideo.src = `videos/${actionObj.name}.mp4`;
  actionVideo.load();
  actionVideo.style.opacity = 1;

  actionVideo.play().catch(() => reset(actionObj));

  actionVideo.onended = () => reset(actionObj);
  actionVideo.onerror = () => reset(actionObj);
}

function reset(actionObj) {
  actionVideo.pause();
  actionVideo.currentTime = 0;
  actionVideo.style.opacity = 0;

  db.ref("actionQueue/" + actionObj.key).remove();

  isPlaying = false;
  processQueue();
}

/* ===== PRODUCT CROSSFADE ===== */

const productImgs = [
  "product-previews/1.png",
  "product-previews/2.png",
  "product-previews/3.png",
  "product-previews/4.png",
  "product-previews/5.png"
];

let pIdx = 0;
let showingA = true;
const imgA = document.getElementById("imgA");
const imgB = document.getElementById("imgB");

setInterval(() => {
  pIdx = (pIdx + 1) % productImgs.length;
  const incoming = showingA ? imgB : imgA;
  const outgoing = showingA ? imgA : imgB;

  incoming.src = productImgs[pIdx];
  incoming.style.opacity = 1;
  outgoing.style.opacity = 0;

  showingA = !showingA;
}, 4000);

/* ===== FULLSCREEN ===== */

const fsBtn = document.getElementById("fsBtn");

fsBtn.addEventListener("click", () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen?.();
  } else {
    document.exitFullscreen?.();
  }
});
</script>

</body>
</html>
