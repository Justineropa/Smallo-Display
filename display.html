<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Smallo Display</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body {
    margin: 0;
    background: #000;
  }

  .right-panel {
    width: 100%;
    height: 100vh;
    background: #fff5e1;
    display: flex;
    flex-direction: column;
  }

  .smallo-area {
    position: relative;
    flex: 1;
    overflow: hidden;
  }

  video {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  #idleVideo {
    z-index: 1;
  }

  #actionVideo {
    z-index: 0;
    visibility: hidden;
  }

  .status {
    text-align: center;
    font-size: 14px;
    opacity: 0.5;
  }
</style>
</head>

<body>

<div class="right-panel">
  <div class="smallo-area">
    <video id="idleVideo" autoplay loop muted playsinline></video>
    <video id="actionVideo" muted playsinline></video>
  </div>
  <div class="status" id="statusText">Idle</div>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyC7FVnMrkhPIF3fJE0JZEmwjDALSFc7SFc",
  authDomain: "smallo-live.firebaseapp.com",
  databaseURL: "https://smallo-live-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "smallo-live",
  storageBucket: "smallo-live.firebasestorage.app",
  messagingSenderId: "1017470725882",
  appId: "1:1017470725882:web:929ee126247fcbb51e6343",
  measurementId: "G-QTZTK6G2XL"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= ELEMENTS ================= */
const idleVideo = document.getElementById("idleVideo");
const actionVideo = document.getElementById("actionVideo");
const statusText = document.getElementById("statusText");

/* ================= STATE ================= */
let queuedAction = null;
let actionPlaying = false;

/* ================= SETUP ================= */
idleVideo.src = "videos/idle.mp4";
idleVideo.play();

/* ================= ACTION QUEUE ================= */
db.ref("action").on("value", snap => {
  const action = snap.val();
  if (!action || actionPlaying) return;

  queuedAction = action;
  statusText.textContent = `Queued: ${action}`;
});

/* ================= IDLE LOOP EDGE ================= */
idleVideo.addEventListener("timeupdate", () => {
  if (!queuedAction || actionPlaying) return;

  if (idleVideo.duration - idleVideo.currentTime < 0.05) {
    startAction(queuedAction);
    queuedAction = null;
  }
});

/* ================= ACTION PLAY ================= */
function startAction(action) {
  actionPlaying = true;
  statusText.textContent = `Playing: ${action}`;

  let path = `videos/${action}.mp4`;

  actionVideo.src = path;
  actionVideo.load();

  actionVideo.onloadeddata = () => {
    idleVideo.pause();

    actionVideo.style.visibility = "visible";
    actionVideo.style.zIndex = 2;
    idleVideo.style.zIndex = 1;

    actionVideo.play();
  };
}

/* ================= ACTION END ================= */
actionVideo.addEventListener("ended", () => {
  statusText.textContent = "Idle";

  actionVideo.style.visibility = "hidden";
  actionVideo.style.zIndex = 0;

  idleVideo.currentTime = 0;
  idleVideo.play();

  actionPlaying = false;
});

/* ================= RANDOM BLINK ================= */
setInterval(() => {
  if (!actionPlaying && !queuedAction) {
    if (Math.random() < 0.45) {
      queuedAction = "blink";
    }
  }
}, 9000);

</script>
</body>
</html>
